<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>G√©n√©rateur d'E-mail Temporaire</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .email {
      font-size: 1.2em;
      font-weight: bold;
      margin-top: 10px;
    }
    .message-content {
      margin-top: 10px;
      display: none;
    }
    .message-attachment {
      margin-top: 5px;
      color: blue;
    }
  </style>
</head>
<body>
  <h1>üéØ Votre E-mail Temporaire</h1>
  <button onclick="generateEmail()">G√©n√©rer une adresse</button>
  <div class="email" id="email"></div>
  <div id="messages"></div>

  <script>
    let token = null;

    // Fonction pour g√©n√©rer un e-mail temporaire
    async function generateEmail() {
      const domainResponse = await fetch('https://api.mail.tm/domains');
      const domains = await domainResponse.json();

      const random = Math.random().toString(36).substring(2, 10);
      const email = `${random}@${domains["hydra:member"][0].domain}`;
      const password = "azerty123"; // mot de passe simple

      // Cr√©er le compte
      await fetch('https://api.mail.tm/accounts', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: email, password: password })
      });

      // Se connecter
      const tokenResponse = await fetch('https://api.mail.tm/token', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: email, password: password })
      });

      const tokenData = await tokenResponse.json();
      token = tokenData.token;

      document.getElementById("email").innerText = email;

      // R√©cup√©rer les e-mails re√ßus
      await loadMessages();
    }

    // Fonction pour charger les messages de la bo√Æte de r√©ception
    async function loadMessages() {
      const messagesResponse = await fetch('https://api.mail.tm/messages', {
        headers: { "Authorization": `Bearer ${token}` }
      });

      const messages = await messagesResponse.json();
      let output = "<h2>üì¨ Messages re√ßus :</h2>";

      messages["hydra:member"].forEach(msg => {
        output += `
          <div>
            <strong>De :</strong> ${msg.from.address}<br>
            <strong>Sujet :</strong> ${msg.subject}<br>
            <button onclick="toggleMessageContent('${msg.id}')">Voir le contenu</button>
            <div id="content-${msg.id}" class="message-content"></div>
            <hr>
          </div>
        `;
      });

      document.getElementById("messages").innerHTML = output;
    }

    // Fonction pour afficher le contenu du message
    async function toggleMessageContent(messageId) {
      const contentDiv = document.getElementById(`content-${messageId}`);
      contentDiv.innerHTML = "Chargement...";  // Affiche "Chargement..." en attendant la r√©ponse de l'API

      try {
        const response = await fetch(`https://api.mail.tm/messages/${messageId}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        const messageDetails = await response.json();
        console.log("Message r√©cup√©r√©:", messageDetails);  // D√©bogage : v√©rifier ce qui est renvoy√© par l'API

        if (messageDetails.text) {
          contentDiv.style.display = 'block';
          contentDiv.innerHTML = `
            <strong>Contenu texte :</strong><br>
            <pre>${messageDetails.text}</pre>
          `;
        } else if (messageDetails.html) {
          contentDiv.style.display = 'block';
          contentDiv.innerHTML = `
            <strong>Contenu HTML :</strong><br>
            <div>${messageDetails.html}</div>
          `;
        } else {
          contentDiv.style.display = 'block';
          contentDiv.innerHTML = 'Aucun contenu texte ou HTML disponible dans cet e-mail.';
        }

        // Afficher les pi√®ces jointes (s'il y en a)
        if (messageDetails.attachments && messageDetails.attachments.length > 0) {
          const attachmentsDiv = document.createElement('div');
          attachmentsDiv.innerHTML = '<strong>Pi√®ces jointes :</strong><br>';
          
          messageDetails.attachments.forEach(att => {
            const attachmentLink = document.createElement('a');
            attachmentLink.href = att.url;
            attachmentLink.target = "_blank";
            attachmentLink.className = 'message-attachment';
            attachmentLink.innerText = `${att.name} (${att.size} octets)`;
            attachmentsDiv.appendChild(attachmentLink);
            attachmentsDiv.appendChild(document.createElement('br'));
          });

          contentDiv.appendChild(attachmentsDiv);
        }

      } catch (error) {
        contentDiv.style.display = 'block';
        contentDiv.innerHTML = 'Erreur lors de la r√©cup√©ration du message.';
        console.error('Erreur API:', error);
      }
    }
  </script>
</body>
</html>
